# InnoDB的索引

## 数据结构

>数据结构是B+树，最顶点为根节点，最底层为存放真实数据的数据页，而中间部分是存放目录项的数据页。  
一般来说，一棵B+树不会超过四层，通过至多三次的目录项数据页二分查找，就可以定位到存放真实数据的数据页，然后在数据页内根据`Page Directory`再进行二分查找，就可以很快定位到数据了。

![B+树数据结构](https://user-gold-cdn.xitu.io/2019/4/9/16a01bd2a6fb9126?imageslim)

## 聚簇索引

>聚簇索引是一种B+树，拥有两个特性：

- 使用记录主键值的大小进行记录和页的排序
- B+树的叶子节点存储的是完整的用户记录

## 二级索引

>类似聚簇索引，特性如下（假设我们为c2列建立索引）：

- 使用记录c2列的大小进行记录和页的排序
- B+树的叶子节点存储的并不是完整的用户记录，而只是c2列+主键这两个列的值
- 目录项记录中不再是主键+页号的搭配，而变成了主键+c2列+页号的搭配
- 为了获取完整的用户记录，需要再根据主键去聚簇索引获取数据，也成为**回表**操作

## 联合索引

>本质上也是一个二级索引，特性如下（假设我们为c2列、c3列建立索引）：

- 先把各个记录和页按照c2列进行排序
- 在记录的c2列相同的情况下，采用c3列进行排序

## 注意事项

- 一棵B+树从根节点开始创建，然后插数据，满了之后，则创建子节点页，把数据移动过去，它们再通过页分裂去安排数据。则根节点的位置是固定的，不移动的，便于存储引擎进行定位
- 引擎规定一个数据页至少存储两条记录

## MyISAM中的索引方案简单介绍

- 采用树形结构，但是将数据放到数据文件中，将索引放到索引文件中
- 从索引文件中定位出行号，再拿行号到数据文件中去找数据，意味着MyISAM中建立的索引相当于全部都是二级索引

## B+树索引的使用

- B+树索引在空间和时间上都有代价，所以没事儿别瞎建索引。

- B+树索引适用于下边这些情况：
  - 全值匹配
  - 匹配左边的列
  - 匹配范围值
  - 精确匹配某一列并范围匹配另外一列
  - 用于排序
  - 用于分组

- 在使用索引时需要注意下边这些事项：
  - 只为用于搜索、排序或分组的列创建索引
  - 为列的基数大的列创建索引
  - 索引列的类型尽量小
  - 可以只对字符串值的前缀建立索引
  - 只有索引列在比较表达式中单独出现才可以适用索引
  - 为了尽可能少的让聚簇索引发生页面分裂和记录移位的情况，建议让主键拥有AUTO_INCREMENT属性。
  - 定位并删除表中的重复和冗余索引
  - 尽量使用覆盖索引进行查询，避免回表带来的性能损耗。